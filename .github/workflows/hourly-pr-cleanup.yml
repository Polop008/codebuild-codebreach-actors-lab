name: Hourly Seed PR Cleanup

on:
  schedule:
    - cron: "17 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  cleanup-seed-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Close non-seed PRs hourly; close seed PRs only after 12h
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const seedLabel = "lab-seed-pr";
            const now = new Date();

            const pulls = await github.paginate(github.rest.pulls.list, {
              owner, repo, state: "open", per_page: 100
            });

            for (const pr of pulls) {
              const labels = (pr.labels || []).map(l => l.name);
              const isSeed = labels.includes(seedLabel);

              const created = new Date(pr.created_at);
              const ageHours = (now - created) / (1000 * 60 * 60);
              if (isSeed && ageHours < 12) continue;

              const reason = isSeed
                ? "Auto-closed by hourly cleanup after 12h seed lifetime."
                : "Auto-closed by hourly cleanup (non-seed PR).";

              await github.rest.issues.createComment({
                owner, repo, issue_number: pr.number,
                body: reason
              });

              await github.rest.pulls.update({ owner, repo, pull_number: pr.number, state: "closed" });

              if (!pr.head.repo || pr.head.repo.full_name === `${owner}/${repo}`) {
                const ref = `heads/${pr.head.ref}`;
                try {
                  await github.rest.git.deleteRef({ owner, repo, ref });
                } catch (e) {
                  core.warning(`Could not delete ${ref}: ${e.message}`);
                }
              }
            }
